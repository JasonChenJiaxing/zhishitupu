
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/AI.jpg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>4.3 Pipeline方法实现关系抽取 - 红蜘蛛知识图谱项目V3.0</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pipline" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="红蜘蛛知识图谱项目V3.0" class="md-header__button md-logo" aria-label="红蜘蛛知识图谱项目V3.0" data-md-component="logo">
      
  <img src="../img/AI.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            红蜘蛛知识图谱项目V3.0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4.3 Pipeline方法实现关系抽取
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="红蜘蛛知识图谱项目V3.0" class="md-nav__button md-logo" aria-label="红蜘蛛知识图谱项目V3.0" data-md-component="logo">
      
  <img src="../img/AI.jpg" alt="logo">

    </a>
    红蜘蛛知识图谱项目V3.0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          第一章:红蜘蛛项目简介
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章:红蜘蛛项目简介" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          第一章:红蜘蛛项目简介
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%80%E7%AB%A0%EF%BC%9A%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF/1.%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B.html" class="md-nav__link">
        1.1 项目背景介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%80%E7%AB%A0%EF%BC%9A%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF/2.%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E6%8A%80%E6%9C%AF%E6%A6%82%E6%8B%AC.html" class="md-nav__link">
        1.2 知识图谱技术概括
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第二章:项目工具介绍
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章:项目工具介绍" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第二章:项目工具介绍
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7/01-%E9%A1%B9%E7%9B%AE%E5%BA%94%E7%94%A8%E5%B7%A5%E5%85%B7.html" class="md-nav__link">
        2.1 项目应用工具概览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7/02-doccano%E6%95%B0%E6%8D%AE%E6%A0%87%E6%B3%A8%E5%B9%B3%E5%8F%B0.html" class="md-nav__link">
        2.2 doccano数据标注平台
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7/03-%E7%9F%A5%E8%AF%86%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80.html" class="md-nav__link">
        2.3 知识查询语言
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%B7%A5%E5%85%B7/04-Neo4j%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93.html" class="md-nav__link">
        2.4 Neo4j图数据库
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第三章:实体抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第三章:实体抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第三章:实体抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E5%AE%9E%E4%BD%93%E6%8A%BD%E5%8F%96/01-%E5%AE%9E%E4%BD%93%E8%AF%86%E5%88%AB%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86.html" class="md-nav__link">
        3.1 实体识别基本知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E5%AE%9E%E4%BD%93%E6%8A%BD%E5%8F%96/02-%E5%9F%BA%E4%BA%8E%E8%A7%84%E5%88%99%E5%AE%9E%E7%8E%B0NER.html" class="md-nav__link">
        3.2 基于规则实现NER
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E5%AE%9E%E4%BD%93%E6%8A%BD%E5%8F%96/03-%E5%9F%BA%E4%BA%8EBiLSTM%2BCRF%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0NER.html" class="md-nav__link">
        3.3 基于深度学习模型实现NER
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E5%AE%9E%E4%BD%93%E6%8A%BD%E5%8F%96/04-Veterbi%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D%28%E6%89%A9%E5%B1%95%E8%B5%84%E6%96%99%29.html" class="md-nav__link">
        3.4 Veterbi算法介绍(扩展资料)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          第四章:关系抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第四章:关系抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          第四章:关系抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="01-%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86.html" class="md-nav__link">
        4.1 关系抽取基本知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="02-%E8%A7%84%E5%88%99%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96.html" class="md-nav__link">
        4.2 规则方法实现关系抽
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          4.3 Pipeline方法实现关系抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="03-Pipeline%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96.html" class="md-nav__link md-nav__link--active">
        4.3 Pipeline方法实现关系抽取
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-pipeline" class="md-nav__link">
    1 Pipeline方法的原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-bilstmattention" class="md-nav__link">
    2 BiLSTM+Attention算法思想
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-bilstmattention" class="md-nav__link">
    3 BiLSTM+Attention模型架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4 整体代码架构图
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5 数据预处理
  </a>
  
    <nav class="md-nav" aria-label="5 数据预处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    第一步: 查看项目数据集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    第二步:编写Config类项目文件配置代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    第三步:  编写数据处理相关函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasetdataloader" class="md-nav__link">
    第四步: 构建DataSet类以及Dataloader函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-bilstmattention" class="md-nav__link">
    6 BiLSTM+Attention模型搭建
  </a>
  
    <nav class="md-nav" aria-label="6 BiLSTM+Attention模型搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    第一步: 编写模型类的代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    第二步: 编写训练函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    第三步: 编写模型预测函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-pipeline" class="md-nav__link">
    7 Pipeline方法的优缺点
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    小节总结
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="04-Joint%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96.html" class="md-nav__link">
        4.4 Joint方法实现关系抽取
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          第五章:知识融合
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第五章:知识融合" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          第五章:知识融合
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E7%9F%A5%E8%AF%86%E8%9E%8D%E5%90%88/01-%E7%9F%A5%E8%AF%86%E8%9E%8D%E5%90%88%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86.html" class="md-nav__link">
        5.1 知识融合基本知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E7%9F%A5%E8%AF%86%E8%9E%8D%E5%90%88/02-%E5%AE%9E%E4%BD%93%E6%B6%88%E6%AD%A7%E4%BB%BB%E5%8A%A1.html" class="md-nav__link">
        5.2 实体消歧任务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          第六章:图谱搭建
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第六章:图谱搭建" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          第六章:图谱搭建
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9A%E5%9B%BE%E8%B0%B1%E6%90%AD%E5%BB%BA/01-Neo4j%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93.html" class="md-nav__link">
        6.1 Neo4j图数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9A%E5%9B%BE%E8%B0%B1%E6%90%AD%E5%BB%BA/02-%E5%8C%BB%E7%96%97%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E7%9A%84%E6%90%AD%E5%BB%BA.html" class="md-nav__link">
        6.2 医疗知识图谱的搭建
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          第七章:图谱应用
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第七章:图谱应用" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          第七章:图谱应用
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E5%9B%BE%E8%B0%B1%E5%BA%94%E7%94%A8/01-%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html" class="md-nav__link">
        7.1 问答系统基础知识
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E5%9B%BE%E8%B0%B1%E5%BA%94%E7%94%A8/02-%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF.html" class="md-nav__link">
        7.2 问答系统关键技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E5%9B%BE%E8%B0%B1%E5%BA%94%E7%94%A8/03-%E5%8C%BB%E7%96%97KBQA%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.html" class="md-nav__link">
        7.3 医疗KBQA系统架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E5%9B%BE%E8%B0%B1%E5%BA%94%E7%94%A8/04-%E5%8C%BB%E7%96%97KBQA%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0.html" class="md-nav__link">
        7.4 医疗KBQA系统实现
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-pipeline" class="md-nav__link">
    1 Pipeline方法的原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-bilstmattention" class="md-nav__link">
    2 BiLSTM+Attention算法思想
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-bilstmattention" class="md-nav__link">
    3 BiLSTM+Attention模型架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4 整体代码架构图
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5 数据预处理
  </a>
  
    <nav class="md-nav" aria-label="5 数据预处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    第一步: 查看项目数据集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#config" class="md-nav__link">
    第二步:编写Config类项目文件配置代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    第三步:  编写数据处理相关函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datasetdataloader" class="md-nav__link">
    第四步: 构建DataSet类以及Dataloader函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-bilstmattention" class="md-nav__link">
    6 BiLSTM+Attention模型搭建
  </a>
  
    <nav class="md-nav" aria-label="6 BiLSTM+Attention模型搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    第一步: 编写模型类的代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    第二步: 编写训练函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    第三步: 编写模型预测函数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-pipeline" class="md-nav__link">
    7 Pipeline方法的优缺点
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    小节总结
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="pipline">Pipline方法实现关系抽取<a class="headerlink" href="#pipline" title="Permanent link">&para;</a></h1>
<h2 id="_1">学习目标<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>理解Pipeline方法的原理</li>
<li>理解BiLSTM+Attention模型的思想</li>
<li>掌握BiLSTM+Attention模型代码的实现</li>
<li>掌握Pipeline方法的优缺点</li>
</ul>
<hr />
<hr />
<h2 id="1-pipeline">1 Pipeline方法的原理<a class="headerlink" href="#1-pipeline" title="Permanent link">&para;</a></h2>
<ul>
<li>pipeline方法是指在实体识别已经完成的基础上再进行实体之间关系的抽取. </li>
<li>早期的流水线学习方法主要采用卷积神经网络 (CNN) 和循环神经网络 (RNN) 两大类结构．其中，CNN多样性卷积核的特性有利于识别目标的结构特征，而RNN能充分考虑长距离词之间的依赖性，其记忆功能有利于识别序列．随着深度学习的不断发展, 研究者不断改进和完善CNN和RNN的方法，并产生了许多变体，如长短期记忆网络 (LSTM) 、双向长短期记忆网 (BI-LSTM) 、等，从而进一步促进了关系抽取的发展．</li>
</ul>
<hr />
<ul>
<li>pipeline方法流程：<ul>
<li>先对输入的句子进行实体抽取，将识别出的实体分别组合；然后再进行关系分类.</li>
<li>注意：这两个子过程是前后串联的，完全分离.</li>
</ul>
</li>
</ul>
<hr />
<h2 id="2-bilstmattention">2 BiLSTM+Attention算法思想<a class="headerlink" href="#2-bilstmattention" title="Permanent link">&para;</a></h2>
<ul>
<li>BiLSTM+Attention模型最初由Zhou等人在2016年的论文《Attention-Based Bidirectional Long Short-Term Memory Networks for Relation Classification》中提出. </li>
<li>该模型结合了双向长短时记忆网络 (Bidirectional LSTM) 和注意力机制 (Attention) ，用于处理输入序列并提取关系信息. 该模型并被应用于关系分类任务. </li>
</ul>
<hr />
<h2 id="3-bilstmattention">3 BiLSTM+Attention模型架构<a class="headerlink" href="#3-bilstmattention" title="Permanent link">&para;</a></h2>
<div align=center><img src="./img/3-2-1.png" style="zoom:80%" ><img/></div>

<hr />
<ul>
<li>
<p>基于上图模型架构所示: BiLSTM+Attention模型整体分为五个部分: </p>
<ul>
<li>输入层 (Input Layer) : 输入的是句子，可以是字符序列也可以是单词序列，或者两者相结合. 此外，对于句子中的两个实体，分别计算各个字符相对于实体的位置. 比如有如下样本: </li>
</ul>
<blockquote>
<div class="highlight"><pre><span></span><code>文本描述: “在《逃学威龙》这部电影中周星驰和吴孟达联合出演”
在这个样本中，实体1为周星驰，实体2为吴孟达. 关系为合作关系. 对于第一个字符“在”字来说，其相对于实体1的距离为: “在”字在字符序列中的索引-实体1在字符序列中的索引. 相对于实体2的距离为: “在”字在字符序列中的索引-实体2在字符序列中的索引. 
因此，模型的输入为子序列+字符的相对位置编码
</code></pre></div>
</blockquote>
<ul>
<li>词嵌入层 (Embedding Layer) : 将每个单词映射到一个高维向量表示，包括: 字符或词嵌入以及相对位置编码的嵌入，可以使用预训练的词向量或从头开始训练. </li>
</ul>
<ul>
<li>双向LSTM层 (BiLSTM Layer) : LSTM是一种递归神经网络，它可以对序列数据进行建模，用于从句子中提取特征. BiLSTM是一种双向LSTM，它能够同时捕捉上下文信息，包括前向和后向信息，因此在关系抽取任务中得到了广泛应用. </li>
</ul>
<ul>
<li>
<p>注意力机制层 (Attention Layer) : 注意力机制可以让模型集中注意力于关键词或片段，有助于提高模型的性能. 这里注意力机制被用来确定每个句子中的单词对于关系分类的重要性. 具体来说，对于输入句子中的每个单词，注意力机制会为其分配一个权重，表示该单词对于关系分类的重要程度. 这些权重将被用于加权输入句子中每个单词的表示，以计算关系分类的输出. 本次注意力机制的实现是采用的基于注意力权重的加权平均池化方式. </p>
<ul>
<li>
<p>具体实现方式如下: </p>
<ul>
<li>第一步: 将 BiLSTM 网络的输出 <span class="arithmatex"><span class="MathJax_Preview">H</span><script type="math/tex">H</script></span> 经过一个 <span class="arithmatex"><span class="MathJax_Preview">tanh</span><script type="math/tex">tanh</script></span> 激活函数，得到一个矩阵<span class="arithmatex"><span class="MathJax_Preview">M</span><script type="math/tex">M</script></span></li>
</ul>
<div class="arithmatex">
<div class="MathJax_Preview">
M = tanh(H)
</div>
<script type="math/tex; mode=display">
M = tanh(H)
</script>
</div>
<ul>
<li>第二步: 将 <span class="arithmatex"><span class="MathJax_Preview">M</span><script type="math/tex">M</script></span> 作为输入，通过权重向量 <span class="arithmatex"><span class="MathJax_Preview">w^T</span><script type="math/tex">w^T</script></span> 和一个 softmax 函数，计算每个单词对于关系分类的重要程度，得到的结果是一个权重向量 <span class="arithmatex"><span class="MathJax_Preview">α</span><script type="math/tex">α</script></span> .</li>
</ul>
<div class="arithmatex">
<div class="MathJax_Preview">
α = softmax(w^T*M)
</div>
<script type="math/tex; mode=display">
α = softmax(w^T*M)
</script>
</div>
<ul>
<li>第三步: 将BiLSTM网络的输出 <span class="arithmatex"><span class="MathJax_Preview">H</span><script type="math/tex">H</script></span> 和注意力权重 <span class="arithmatex"><span class="MathJax_Preview">α</span><script type="math/tex">α</script></span> 相乘得到一个加权和 <span class="arithmatex"><span class="MathJax_Preview">r</span><script type="math/tex">r</script></span></li>
</ul>
<div class="arithmatex">
<div class="MathJax_Preview">
r = H * α^T
</div>
<script type="math/tex; mode=display">
r = H * α^T
</script>
</div>
<ul>
<li>第四步: 将第三步得到的结果 <span class="arithmatex"><span class="MathJax_Preview">r</span><script type="math/tex">r</script></span> ，经过一个 <span class="arithmatex"><span class="MathJax_Preview">tanh</span><script type="math/tex">tanh</script></span> 激活函数，得到最终加权后的输入句子中每个单词的表示，以方便后续计算关系分类的输出</li>
</ul>
</li>
</ul>
<div class="arithmatex">
<div class="MathJax_Preview">
h^* = tanh(r)
</div>
<script type="math/tex; mode=display">
h^* = tanh(r)
</script>
</div>
</li>
</ul>
<ul>
<li>输出层 (Output Layer) : 根据任务的不同，输出层可以是分类层或回归层. 在关系抽取任务中，输出层通常是一个分类层，用于预测两个实体之间的关系类型. </li>
</ul>
</li>
</ul>
<hr />
<h2 id="4">4 整体代码架构图<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<div align=center><img src="./img/3-3-1.png" style="zoom:55%" ><img/></div>

<hr />
<h2 id="5">5 数据预处理<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<ul>
<li>本项目中对数据部分的预处理步骤如下:<ul>
<li>第一步: 查看项目数据集</li>
<li>第二步: 编写Config类项目文件配置代码</li>
<li>第三步: 编写数据处理相关函数</li>
<li>第四步: 构建DataSet类与dataloader函数</li>
</ul>
</li>
</ul>
<hr />
<h3 id="_2">第一步: 查看项目数据集<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li>本次项目数据原始来源为公开的千言数据集https://<a href="http://www.luge.ai/#/">www.luge.ai/#/</a>，使用开源数据的好处，我们无需标注直接使用即可，本次项目的主要需要大家掌握实现关系抽取的思想。</li>
</ul>
<hr />
<ul>
<li>本次项目数据的路径为: /home/ec2-user/Bilstm_Attention_RE/data</li>
<li>项目的数据集包括3个文件:</li>
<li>第一个关系类型文件: /home/ec2-user/Bilstm_Attention_RE/data/relation2id.txt</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code>导演 0
歌手 1
作曲 2
作词 3
主演 4
</code></pre></div>
<hr />
<blockquote>
<ul>
<li>relation2id.txt中包含5个类别标签, 文件共分为两列，第一列是类别名称，第二列为类别序号，中间空格符号隔开</li>
</ul>
</blockquote>
<ul>
<li>第二个训练数据集: /home/ec2-user/Bilstm_Attention_RE/data/train.txt</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code>今晚会在哪里醒来 黄家强 歌手 《今晚会在哪里醒来》是黄家强的一首粤语歌曲，由何启弘作词，黄家强作曲编曲并演唱，收录于2007年08月01日发行的专辑《她他》中

似水流年 许晓杰 作曲 似水流年，由著名作词家闫肃作词，著名音乐人许晓杰作曲，张烨演唱

交涉人 朝日电视台 出品公司 《交涉人》是日本朝日电视台制作并播出的8集悬疑推理电视剧

生活启示录 闫妮 主演 05闫妮接到《生活启示录》之后，就向王丽萍推荐了胡歌

北京北京 汪峰 歌手 ”汪峰我印象最深刻的是汪峰的《北京北京》蚀骨唱成烛骨

千岁情人 王菲 主演 难怪春晚把那英秒成不一样很多人都不知道 王菲演 的这部《千岁情人》，是1993年的一部穿越剧
天使的咒语 魏雪漫 歌手 魏雪漫专辑《天使的咒语》的同名主打歌曲

与青春有关的日子 白百何 主演 白百何的处女座是《与青春有关的日子》，合作的演员是佟大为、陈羽凡

高高至上 秋言 作词 专辑曲目序号　　曲目作词作曲编曲1高高至上秋言秋言彭飞2高高至上（伴奏）　　秋言秋言彭飞
</code></pre></div>
<hr />
<blockquote>
<p>train.txt 中包含18267行样本, 每行分为4列元素，元素中间用空格隔开，第一列元素为实体1、第二列元素为实体2、第三列元素为关系类型、第四列元素是原始文本</p>
</blockquote>
<hr />
<ul>
<li>第三个测试数据集:/home/ec2-user/Bilstm_Attention_RE/data/test.txt</li>
</ul>
<hr />
<div class="highlight"><pre><span></span><code>三生三世十里桃花 安悦溪 主演 当《三生三世》4位女星换上现代装: 第四，安悦溪在《三生三世十里桃花》中饰演少辛，安悦溪穿上现代装十分亮眼，气质清新脱俗

失恋33天 白百何 主演 2011年，担任爱情片《失恋33天》的编剧，该片改编自鲍鲸鲸的同名小说，由文章、白百何共同主演6

爱人们的故事 裴勇俊 主演 《爱人们的故事》是全基尚导演，裴勇俊、李英爱、李慧英等主演的18集爱情类型的电视剧

为你叫好 吕薇 歌手 基本资料　　歌曲名称: 为你叫好1歌手: 吕薇　　所属专辑: 《但愿人长久》歌词　　歌手: 吕薇　　词: 清风 曲: 刘青

卡拉是条狗 路学长 导演 个人生活李佳璇和导演路学长因拍摄《卡拉是条狗》而相识，2003年两人结婚

上帝创造女人 简-路易斯·特林提格南特 主演 《上帝创造女人》是罗杰·瓦迪姆执导的粉红浪漫爱情影片，由碧姬·芭铎和简-路易斯·特林提格南特参加演出

上帝创造女人 碧姬·芭铎 主演 《上帝创造女人》是罗杰·瓦迪姆执导的粉红浪漫爱情影片，由碧姬·芭铎和简-路易斯·特林提格南特参加演出
</code></pre></div>
<hr />
<blockquote>
<p>test.txt中包含5873行样本,  每行分为4列元素，元素中间用空格隔开，第一列元素为实体1、第二列元素为实体2、第三列元素为关系类型、第四列元素是原始文本</p>
</blockquote>
<hr />
<hr />
<h3 id="config">第二步:编写Config类项目文件配置代码<a class="headerlink" href="#config" title="Permanent link">&para;</a></h3>
<ul>
<li>Config类文件路径为: /home/ec2-user/Bilstm_Attention_RE/config.py</li>
</ul>
<hr />
<ul>
<li>config文件目的: 配置项目常用变量，一般这些变量属于不经常改变的，比如: 训练文件路径、模型训练次数、模型超参数等等</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># coding:utf-8</span>
<span class="kn">import</span> <span class="nn">torch</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data_path</span> <span class="o">=</span> <span class="s2">&quot;训练文件绝对路径名称&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data_path</span> <span class="o">=</span> <span class="s2">&quot;测试文件绝对路径名称&quot;</span>                      
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_data_path</span> <span class="o">=</span> <span class="s2">&quot;关系类型文件绝对路径名称&quot;</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="mi">70</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-3</span>
</code></pre></div>
<hr />
<h3 id="_3">第三步:  编写数据处理相关函数<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<ul>
<li>数据处理相关函数的路径为: /home/ec2-user/Bilstm_Attention_RE/utils/process.py</li>
</ul>
<hr />
<ul>
<li>首选导入必备的工具包</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># coding:utf-8</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="n">conf</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
<span class="c1"># 获取关系类型字典</span>
<span class="n">relation2id</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">rel_data_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">word</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">relation2id</span><span class="p">:</span>
            <span class="n">relation2id</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
</code></pre></div>
<hr />
<ul>
<li>构建第一个数据处理相关函数sent_padding,  位于process.py中的独立函数.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sent_padding</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">word2id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;把句子 words 转为 id 形式，并自动补全为 max_len 长度。&quot;&quot;&quot;</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word2id</span><span class="p">:</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word2id</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word2id</span><span class="p">[</span><span class="s1">&#39;UNKNOW&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ids</span><span class="p">[:</span><span class="n">conf</span><span class="o">.</span><span class="n">max_len</span><span class="p">]</span>
    <span class="n">ids</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">word2id</span><span class="p">[</span><span class="s1">&#39;BLANK&#39;</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">max_len</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">ids</span>
</code></pre></div>
<hr />
<ul>
<li>构建第二个数据处理相关函数pos,  位于process.py中的独立函数.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    将实体位置信息进行转换，因为pos_embedding不能出现负数</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">70</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">70</span> <span class="ow">and</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">70</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">+</span><span class="mi">70</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">142</span>
</code></pre></div>
<hr />
<ul>
<li>构建第三个数据处理相关函数position_padding,  位于process.py中的独立函数.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">position_padding</span><span class="p">(</span><span class="n">pos_ids</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    &quot;&quot;&quot;把 pos位置信息 转为 id 形式，并自动补全为 max_len 长度。&quot;&quot;&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pos_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pos_ids</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">conf</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pos_ids</span><span class="p">[:</span><span class="n">conf</span><span class="o">.</span><span class="n">max_len</span><span class="p">]</span>
    <span class="n">pos_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">142</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_ids</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">pos_ids</span>
</code></pre></div>
<hr />
<ul>
<li>构建第四个数据处理相关函数get_train_data,  位于process.py中的独立函数.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_txt_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    编码训练、测试数据集格式</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">positionE1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">positionE2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">relation2id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="k">as</span> <span class="n">tfr</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tfr</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">count_dict</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">count_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">sentence</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">position1</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">index2</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">position2</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                    <span class="n">position1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">index1</span><span class="p">)</span>
                    <span class="n">position2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">index2</span><span class="p">)</span>

                <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relation2id</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">positionE1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position1</span><span class="p">)</span>
                <span class="n">positionE2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position2</span><span class="p">)</span>
                <span class="n">count_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">datas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">positionE1</span><span class="p">,</span> <span class="n">positionE2</span><span class="p">,</span> <span class="n">entities</span>
</code></pre></div>
<hr />
<ul>
<li>构建第五个数据处理相关函数get_word_id,  位于 process.py 中的独立函数.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_word_id</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    文本数字化表示处理，得到word2id, id2word</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">datas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">positionE1</span><span class="p">,</span> <span class="n">positionE2</span><span class="p">,</span> <span class="n">entities</span> <span class="o">=</span> <span class="n">get_txt_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">datas</span><span class="p">)))</span>
    <span class="n">word2id</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_list</span><span class="p">)}</span>
    <span class="n">id2word</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">word</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_list</span><span class="p">)}</span>
    <span class="n">word2id</span><span class="p">[</span><span class="s2">&quot;BLANK&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2id</span><span class="p">)</span>
    <span class="n">word2id</span><span class="p">[</span><span class="s2">&quot;UNKNOW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2id</span><span class="p">)</span>
    <span class="n">id2word</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">id2word</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;BLANK&quot;</span>
    <span class="n">id2word</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">id2word</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;UNKNOW&quot;</span>
    <span class="k">return</span> <span class="n">word2id</span><span class="p">,</span> <span class="n">id2word</span>
</code></pre></div>
<hr />
<h3 id="datasetdataloader">第四步: 构建DataSet类以及Dataloader函数<a class="headerlink" href="#datasetdataloader" title="Permanent link">&para;</a></h3>
<ul>
<li>代码路径为: /home/ec2-user/Bilstm_Attention_RE/utils/data_loader.py</li>
</ul>
<hr />
<ul>
<li>首先导入相应的工具包</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># coding:utf-8</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">utils.process</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">torch</span>
</code></pre></div>
<hr />
<ul>
<li>构建第一个数据处理相关类MyDataset, 位于data_loader.py中的独立类.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_txt_data</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
        <span class="n">positionE1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">positionE2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">entites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">positionE1</span><span class="p">,</span> <span class="n">positionE2</span><span class="p">,</span> <span class="n">entites</span>
</code></pre></div>
<hr />
<ul>
<li>构建第二个数据处理相关函数collate_fn,  位于data_loader.py中的独立函数.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">datas</span><span class="p">):</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">]</span>
    <span class="n">positionE1</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">]</span>
    <span class="n">positionE2</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">]</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">]</span>
    <span class="n">word2id</span><span class="p">,</span> <span class="n">id2word</span> <span class="o">=</span> <span class="n">get_word_id</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">)</span>
    <span class="n">sequences_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">sent_padding</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">word2id</span><span class="p">)</span>
        <span class="n">sequences_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">positionE1_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">positionE2_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pos_ids</span> <span class="ow">in</span> <span class="n">positionE1</span><span class="p">:</span>
        <span class="n">pos1_ids</span> <span class="o">=</span> <span class="n">position_padding</span><span class="p">(</span><span class="n">pos_ids</span><span class="p">)</span>
        <span class="n">positionE1_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos1_ids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pos_ids</span> <span class="ow">in</span> <span class="n">positionE2</span><span class="p">:</span>
        <span class="n">pos2_ids</span> <span class="o">=</span> <span class="n">position_padding</span><span class="p">(</span><span class="n">pos_ids</span><span class="p">)</span>
        <span class="n">positionE2_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos2_ids</span><span class="p">)</span>

    <span class="n">datas_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sequences_ids</span><span class="p">,</span> 
                                <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> 
                                <span class="n">device</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">positionE1_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">positionE1_ids</span><span class="p">,</span> 
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> 
                                     <span class="n">device</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">positionE2_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">positionE2_ids</span><span class="p">,</span> 
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> 
                                     <span class="n">device</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">labels_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> 
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> 
                                 <span class="n">device</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">datas_tensor</span><span class="p">,</span> <span class="n">positionE1_tensor</span><span class="p">,</span> <span class="n">positionE2_tensor</span><span class="p">,</span> <span class="n">labels_tensor</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">entities</span>
</code></pre></div>
<hr />
<ul>
<li>构建第三个数据处理相关函数get_loader_data,  位于data_loader.py中的独立函数.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_loader_data</span><span class="p">():</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">)</span>

    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                  <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
                                  <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">test_data</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">test_data_path</span><span class="p">)</span>

    <span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                  <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">,</span>
                                  <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">test_dataloader</span>
</code></pre></div>
<hr />
<h2 id="6-bilstmattention">6 BiLSTM+Attention模型搭建<a class="headerlink" href="#6-bilstmattention" title="Permanent link">&para;</a></h2>
<ul>
<li>本项目中BiLSTN+Attention模型搭建的步骤如下:<ul>
<li>第一步: 编写模型类的代码</li>
<li>第二步: 编写训练函数</li>
<li>第三步: 编写使用模型预测代码的实现.</li>
</ul>
</li>
</ul>
<hr />
<h3 id="_4">第一步: 编写模型类的代码<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li>构建BiLSTM_ATT模型类</li>
<li>代码路径: /home/ec2-user/Bilstm_Attention_RE/model/bilstm_atten.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># coding:utf8</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>


<span class="k">class</span> <span class="nc">BiLSTM_ATT</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">pos_size</span><span class="p">,</span> <span class="n">tag_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BiLSTM_ATT</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">embedding_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">hidden_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos_size</span> <span class="o">=</span> <span class="n">pos_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">pos_dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tag_size</span> <span class="o">=</span> <span class="n">tag_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">word_embeds</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos1_embeds</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_size</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos2_embeds</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_size</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">hidden_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">tag_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_emb</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_att</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">att_weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span>
                                                   <span class="mi">1</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">init_hidden_lstm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att_weight</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>

        <span class="n">init_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_hidden_lstm</span><span class="p">()</span>

        <span class="n">embeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">word_embeds</span><span class="p">(</span><span class="n">sentence</span><span class="p">),</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">pos1_embeds</span><span class="p">(</span><span class="n">pos1</span><span class="p">),</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">pos2_embeds</span><span class="p">(</span><span class="n">pos2</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_emb</span><span class="p">(</span><span class="n">embeds</span><span class="p">)</span>
        <span class="n">embeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">embeds</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">lstm_out</span><span class="p">,</span> <span class="n">lstm_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">embeds</span><span class="p">,</span> <span class="n">init_hidden</span><span class="p">)</span>

        <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">lstm_out</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">lstm_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_lstm</span><span class="p">(</span><span class="n">lstm_out</span><span class="p">)</span>
        <span class="n">att_out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">lstm_out</span><span class="p">))</span>
        <span class="n">att_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_att</span><span class="p">(</span><span class="n">att_out</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">att_out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<hr />
<h3 id="_5">第二步: 编写训练函数<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<ul>
<li>实现训练函数train.py</li>
</ul>
<ul>
<li>代码位置: /home/ec2-user/Bilstm_Attention_RE/train.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># coding:utf-8</span>
<span class="kn">from</span> <span class="nn">model.bilstm_atten</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils.data_loader</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils.process</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">pos_size</span><span class="p">,</span> <span class="n">tag_size</span><span class="p">):</span>
    <span class="c1"># 加载数据集</span>
    <span class="n">train_iter</span><span class="p">,</span> <span class="n">test_iter</span> <span class="o">=</span> <span class="n">get_loader_data</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;训练数据集长度&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_iter</span><span class="p">))</span>
    <span class="c1"># 实例化Bilstm+attention模型</span>
    <span class="n">ba_model</span> <span class="o">=</span> <span class="n">BiLSTM_ATT</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">pos_size</span><span class="p">,</span> <span class="n">tag_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ba_model</span><span class="p">)</span>
    <span class="c1"># 实例化优化器</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">ba_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="c1"># 实例化损失函数</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

    <span class="c1"># 实现模型训练</span>

    <span class="c1"># 定义训练模型参数</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 已经训练样本的损失</span>
    <span class="n">train_acc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 已经训练样本的准确率</span>
    <span class="n">total_iter_num</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 训练迭代次数</span>
    <span class="n">total_sample</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 已经训练的样本数</span>


    <span class="c1"># 开始模型的训练</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_iter</span><span class="p">):</span>
            <span class="c1"># 将数据输入模型</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">ba_model</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">)</span>

            <span class="c1"># 计算损失</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="c1"># 梯度清零</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="c1"># 反向传播</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="c1"># 梯度更新</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="c1"># 计算总损失</span>
            <span class="n">total_iter_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="c1"># 计算总准确率</span>
            <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_acc</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">total_sample</span> <span class="o">=</span> <span class="n">total_sample</span> <span class="o">+</span> <span class="n">label</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># print(f&#39;total_sample---&gt;{total_sample}&#39;)</span>

            <span class="c1"># 每25次训练，打印日志</span>
            <span class="k">if</span> <span class="n">total_iter_num</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tmploss</span> <span class="o">=</span> <span class="n">train_loss</span> <span class="o">/</span> <span class="n">total_iter_num</span>
                <span class="n">tmpacc</span> <span class="o">=</span> <span class="n">train_acc</span> <span class="o">/</span> <span class="n">total_sample</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;轮次: </span><span class="si">%d</span><span class="s1">, 损失:</span><span class="si">%.6f</span><span class="s1">, 时间:</span><span class="si">%d</span><span class="s1">, 准确率:</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmploss</span><span class="p">,</span> <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span> <span class="n">tmpacc</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ba_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s1">&#39;./save_model/20230228_new_model_</span><span class="si">%d</span><span class="s1">.bin&#39;</span> <span class="o">%</span> <span class="n">epoch</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">word2id</span><span class="p">,</span> <span class="n">id2word</span> <span class="o">=</span> <span class="n">get_word_id</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">)</span>
    <span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2id</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">)</span>
    <span class="n">pos_size</span> <span class="o">=</span> <span class="mi">143</span>
    <span class="n">tag_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation2id</span><span class="p">)</span>
    <span class="n">train</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">pos_size</span><span class="p">,</span> <span class="n">tag_size</span><span class="p">)</span>
</code></pre></div>
<hr />
<ul>
<li>模型训练结果展示: </li>
</ul>
<div align=center><img src="./img/3-4-1.png" style="zoom:80%" ><img/></div>

<blockquote>
<p>结论: BiLSTM+Attention模型在训练集上的最终表现是ACC:80%</p>
</blockquote>
<h3 id="_6">第三步: 编写模型预测函数<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<ul>
<li>使用训练好的模型，随机抽取文本进行关系抽取</li>
<li>代码位置: /home/ec2-user/Bilstm_Attention_RE/predict.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># coding:utf-8</span>
<span class="kn">from</span> <span class="nn">model.bilstm_atten</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils.data_loader</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils.process</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># 导入配置文件</span>
<span class="n">conf</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

<span class="c1"># 获取或定义模型参数</span>
<span class="n">word2id</span><span class="p">,</span> <span class="n">id2word</span> <span class="o">=</span> <span class="n">get_word_id</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">)</span>
<span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word2id</span><span class="p">)</span>
<span class="n">pos_size</span> <span class="o">=</span> <span class="mi">143</span>
<span class="n">tag_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">relation2id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tag_size</span><span class="p">)</span>

<span class="c1"># 获取id2relation的映射</span>
<span class="n">id2relation</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">relation2id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># 加载数据集</span>
<span class="n">_</span><span class="p">,</span> <span class="n">test_iter</span> <span class="o">=</span> <span class="n">get_loader_data</span><span class="p">()</span>

<span class="c1"># 实例化Bilstm+attention模型</span>
<span class="n">ba_model</span> <span class="o">=</span> <span class="n">BiLSTM_ATT</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">pos_size</span><span class="p">,</span> <span class="n">tag_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># 加载模型</span>
<span class="n">ba_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./save_model/20230228_new_model_40.bin&#39;</span><span class="p">))</span>


<span class="c1"># 开始模型的预测</span>
<span class="k">def</span> <span class="nf">model2predict</span><span class="p">():</span>
    <span class="n">ba_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">original_sequences</span><span class="p">,</span> <span class="n">original_labels</span><span class="p">,</span> <span class="n">entites</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">test_iter</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">original_labels</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;original_sequences&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_sequences</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;original_labels&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_labels</span><span class="p">))</span>
            <span class="c1"># 将数据输入模型</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">ba_model</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">)</span>
            <span class="c1"># 实现模型的预测</span>
            <span class="n">predict_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_sequences</span><span class="p">)):</span>
                <span class="n">original_sequence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_sequences</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">original_label</span> <span class="o">=</span> <span class="n">id2relation</span><span class="p">[</span><span class="n">original_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="n">entites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">predict_label</span> <span class="o">=</span> <span class="n">id2relation</span><span class="p">[</span><span class="n">predict_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;原始句子: &#39;</span><span class="p">,</span> <span class="n">original_sequence</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;原始关系类别: &#39;</span><span class="p">,</span> <span class="n">original_label</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;实体列表&#39;</span><span class="p">,</span><span class="n">entity</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;模型预测的关系类别: &#39;</span><span class="p">,</span> <span class="n">predict_label</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">model2predict</span><span class="p">()</span>
</code></pre></div>
<hr />
<ul>
<li>预测结果展示:</li>
</ul>
<div align=center><img src="./img/3-4-2.png" style="zoom:80%" ><img/></div>

<hr />
<h2 id="7-pipeline">7 Pipeline方法的优缺点<a class="headerlink" href="#7-pipeline" title="Permanent link">&para;</a></h2>
<hr />
<ul>
<li>优点：<ul>
<li>易于实现，实体模型和关系模型使用独立的数据集，不需要同时标注实体和关系的数据集.</li>
<li>两者相互独立，若关系抽取模型没训练好不会影响到实体抽取.</li>
</ul>
</li>
</ul>
<hr />
<ul>
<li>缺点：<ul>
<li>关系和实体两者是紧密相连的，互相之间的联系没有捕捉到.</li>
<li>容易造成误差积累、实体冗余、交互缺失.</li>
</ul>
</li>
</ul>
<h2 id="_7">小节总结<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<ul>
<li>本章节主要讲解了什么是Pipeline方法，并基于BiLSTM+Attention模型实现了关系抽取任务的训练和评估.</li>
</ul>
<hr />
<hr />





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
      
        
        <a href="02-%E8%A7%84%E5%88%99%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: 4.2 规则方法实现关系抽" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              4.2 规则方法实现关系抽
            </div>
          </div>
        </a>
      
      
        
        <a href="04-Joint%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96.html" class="md-footer__link md-footer__link--next" aria-label="下一页: 4.4 Joint方法实现关系抽取" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              4.4 Joint方法实现关系抽取
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
  </body>
</html>